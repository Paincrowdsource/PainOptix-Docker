name: Check-ins Dispatcher

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Check-ins Dispatch
        id: dispatch
        run: |
          MAX_RETRIES=3
          ATTEMPT=0
          SUCCESS=false

          while [ $ATTEMPT -lt $MAX_RETRIES ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT of $MAX_RETRIES"

            response=$(curl -s -X POST https://painoptix.com/api/checkins/dispatch \
              --connect-timeout 10 \
              --max-time 60 \
              -H "Authorization: Bearer ${{ secrets.DISPATCH_TOKEN }}" \
              -H "Content-Type: application/json" \
              -w "\nHTTP_STATUS:%{http_code}") || true

            # Extract body and status
            body=$(echo "$response" | sed -n '1,/^HTTP_STATUS:/p' | sed '$d')
            status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)

            echo "Response body: $body"
            echo "HTTP status: $status"

            # Check for success
            if [ "$status" = "200" ] && echo "$body" | grep -q '"ok":true'; then
              echo "Dispatch successful"
              SUCCESS=true
              break
            fi

            echo "Attempt $ATTEMPT failed (status=$status)"
            if [ $ATTEMPT -lt $MAX_RETRIES ]; then
              echo "Retrying in 15 seconds..."
              sleep 15
            fi
          done

          if [ "$SUCCESS" != "true" ]; then
            echo "::error::Dispatch failed after $MAX_RETRIES attempts (last status=$status)"
            exit 1
          fi
