name: Check-ins Dispatcher

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Check-ins Dispatch
        id: dispatch
        run: |
          response=$(curl -s -X POST https://painoptix.com/api/checkins/dispatch \
            -H "Authorization: Bearer ${{ secrets.DISPATCH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP_STATUS:%{http_code}")

          # Extract body and status
          body=$(echo "$response" | sed -n '1,/^HTTP_STATUS:/p' | sed '$d')
          status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)

          echo "Response body: $body"
          echo "HTTP status: $status"

          # Check for success
          if [ "$status" != "200" ]; then
            echo "::error::Dispatch failed with status $status"
            exit 1
          fi

          # Verify ok:true in response
          if echo "$body" | grep -q '"ok":true'; then
            echo "✅ Dispatch successful"
          else
            echo "::error::Dispatch returned ok:false"
            echo "$body"
            exit 1
          fi
